<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>database_connections.TJEncryptPassword &mdash; kabbes_database_connections 0.7.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            kabbes_database_connections
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">kabbes_database_connections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">database_connections.TJEncryptPassword</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for database_connections.TJEncryptPassword</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Teradata. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#   File:       TJEncryptPassword.py</span>
<span class="c1">#   Purpose:    Encrypts a password, saves the encryption key in one file, and saves the encrypted password in a second file</span>
<span class="c1">#</span>
<span class="c1">#               This program accepts eight command-line arguments:</span>
<span class="c1">#</span>
<span class="c1">#                 1. Transformation - Specifies the transformation in the form Algorithm/Mode/Padding.</span>
<span class="c1">#                                     Example: AES/CBC/NoPadding</span>
<span class="c1">#</span>
<span class="c1">#                 2. KeySizeInBits  - Specifies the algorithm key size, which governs the encryption strength.</span>
<span class="c1">#                                     Example: 256</span>
<span class="c1">#</span>
<span class="c1">#                 3. MAC            - Specifies the message authentication code (MAC) algorithm HmacSHA1 or HmacSHA256.</span>
<span class="c1">#                                     Example: HmacSHA256</span>
<span class="c1">#</span>
<span class="c1">#                 4. PasswordEncryptionKeyFileName - Specifies a filename in the current directory, a relative pathname, or an absolute pathname.</span>
<span class="c1">#                                     The file is created by this program. If the file already exists, it will be overwritten by the new file.</span>
<span class="c1">#                                     Example: PassKey.properties</span>
<span class="c1">#</span>
<span class="c1">#                 5. EncryptedPasswordFileName - Specifies a filename in the current directory, a relative pathname, or an absolute pathname.</span>
<span class="c1">#                                     The filename or pathname that must differ from the PasswordEncryptionKeyFileName.</span>
<span class="c1">#                                     The file is created by this program. If the file already exists, it will be overwritten by the new file.</span>
<span class="c1">#                                     Example: EncPass.properties</span>
<span class="c1">#</span>
<span class="c1">#                 6. Hostname       - Specifies the Teradata Database hostname.</span>
<span class="c1">#                                     Example: whomooz</span>
<span class="c1">#</span>
<span class="c1">#                 7. Username       - Specifies the Teradata Database username.</span>
<span class="c1">#                                     Example: guest</span>
<span class="c1">#</span>
<span class="c1">#                 8. Password       - Specifies the Teradata Database password to be encrypted.</span>
<span class="c1">#                                     Unicode characters in the password can be specified with the backslash uXXXX escape sequence.</span>
<span class="c1">#                                     Example: please</span>
<span class="c1">#</span>
<span class="c1">#               Overview</span>
<span class="c1">#               --------</span>
<span class="c1">#</span>
<span class="c1">#               Stored Password Protection enables an application to provide a connection password in encrypted form to</span>
<span class="c1">#               the Teradata SQL Driver for Python.</span>
<span class="c1">#</span>
<span class="c1">#               An encrypted password may be specified in the following contexts:</span>
<span class="c1">#                 * A login password specified as the &quot;password&quot; connection parameter.</span>
<span class="c1">#                 * A login password specified within the &quot;logdata&quot; connection parameter.</span>
<span class="c1">#</span>
<span class="c1">#               If the password, however specified, begins with the prefix &quot;ENCRYPTED_PASSWORD(&quot; then the specified password must follow this format:</span>
<span class="c1">#</span>
<span class="c1">#                 ENCRYPTED_PASSWORD(file:PasswordEncryptionKeyFileName,file:EncryptedPasswordFileName)</span>
<span class="c1">#</span>
<span class="c1">#               Each filename must be preceded by the &quot;file:&quot;&quot; prefix.</span>
<span class="c1">#               The PasswordEncryptionKeyFileName must be separated from the EncryptedPasswordFileName by a single comma.</span>
<span class="c1">#               The PasswordEncryptionKeyFileName specifies the name of a properties file that contains the password encryption key and associated information.</span>
<span class="c1">#               The EncryptedPasswordFileName specifies the name of a properties file that contains the encrypted password and associated information.</span>
<span class="c1">#               The two files are described below.</span>
<span class="c1">#</span>
<span class="c1">#               Stored Password Protection is offered by the Teradata JDBC Driver and the Teradata SQL Driver for Python.</span>
<span class="c1">#               The same file format is used by both drivers.</span>
<span class="c1">#</span>
<span class="c1">#               This program works in conjunction with Stored Password Protection offered by the Teradata JDBC Driver and the</span>
<span class="c1">#               Teradata SQL Driver for Python. This program creates the files containing the password encryption key and encrypted password,</span>
<span class="c1">#               which can be subsequently specified via the &quot;ENCRYPTED_PASSWORD(&quot; syntax.</span>
<span class="c1">#</span>
<span class="c1">#               You are not required to use this program to create the files containing the password encryption key and encrypted password.</span>
<span class="c1">#               You can develop your own software to create the necessary files.</span>
<span class="c1">#               The only requirement is that the files must match the format expected by the Teradata SQL Driver for Python, which is documented below.</span>
<span class="c1">#</span>
<span class="c1">#               This program encrypts the password and then immediately decrypts the password, in order to verify that the password can be</span>
<span class="c1">#               successfully decrypted. This program mimics the password decryption of the Teradata SQL Driver for Python, and is intended</span>
<span class="c1">#               to openly illustrate its operation and enable scrutiny by the community.</span>
<span class="c1">#</span>
<span class="c1">#               The encrypted password is only as safe as the two files. You are responsible for restricting access to the files containing</span>
<span class="c1">#               the password encryption key and encrypted password. If an attacker obtains both files, the password can be decrypted.</span>
<span class="c1">#               The operating system file permissions for the two files should be as limited and restrictive as possible, to ensure that</span>
<span class="c1">#               only the intended operating system userid has access to the files.</span>
<span class="c1">#</span>
<span class="c1">#               The two files can be kept on separate physical volumes, to reduce the risk that both files might be lost at the same time.</span>
<span class="c1">#               If either or both of the files are located on a network volume, then an encrypted wire protocol can be used to access the</span>
<span class="c1">#               network volume, such as sshfs, encrypted NFSv4, or encrypted SMB 3.0.</span>
<span class="c1">#</span>
<span class="c1">#               Example Commands</span>
<span class="c1">#               ----------------</span>
<span class="c1">#</span>
<span class="c1">#               This program uses the Teradata SQL Driver for Python to log on to the specified Teradata Database using the encrypted</span>
<span class="c1">#               password, so the Teradata SQL Driver for Python must have been installed with the &quot;pip install teradatasql&quot; command.</span>
<span class="c1">#</span>
<span class="c1">#               The following commands assume this program file is located in the current directory.</span>
<span class="c1">#               When the Teradata SQL Driver for Python is installed, the sample programs are placed in the teradatasql/samples</span>
<span class="c1">#               directory under your Python installation directory.</span>
<span class="c1">#               Change your current directory to the teradatasql/samples directory under your Python installation directory.</span>
<span class="c1">#</span>
<span class="c1">#               The following example commands illustrate using a 256-bit AES key, and using the HmacSHA256 algorithm.</span>
<span class="c1">#</span>
<span class="c1">#               macOS or Linux: python TJEncryptPassword.py AES/CBC/NoPadding 256 HmacSHA256 PassKey.properties EncPass.properties whomooz guest please</span>
<span class="c1">#               Windows:        py -3 TJEncryptPassword.py AES/CBC/NoPadding 256 HmacSHA256 PassKey.properties EncPass.properties whomooz guest please</span>
<span class="c1">#</span>
<span class="c1">#               Password Encryption Key File Format</span>
<span class="c1">#               -----------------------------------</span>
<span class="c1">#</span>
<span class="c1">#               You are not required to use the TJEncryptPassword program to create the files containing the password encryption key and</span>
<span class="c1">#               encrypted password. You can develop your own software to create the necessary files, but the files must match the format</span>
<span class="c1">#               expected by the Teradata SQL Driver for Python.</span>
<span class="c1">#</span>
<span class="c1">#               The password encryption key file is a text file in Java Properties file format, using the ISO 8859-1 character encoding.</span>
<span class="c1">#</span>
<span class="c1">#               The file must contain the following string properties:</span>
<span class="c1">#</span>
<span class="c1">#                 version=1</span>
<span class="c1">#</span>
<span class="c1">#                       The version number must be 1.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                 transformation=TransformationName</span>
<span class="c1">#</span>
<span class="c1">#                       Specifies the transformation in the form Algorithm/Mode/Padding.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#                       Example: AES/CBC/NoPadding</span>
<span class="c1">#</span>
<span class="c1">#                 algorithm=AlgorithmName</span>
<span class="c1">#</span>
<span class="c1">#                       This value must correspond to the Algorithm portion of the transformation.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#                       Example: AES</span>
<span class="c1">#</span>
<span class="c1">#                 match=MatchValue</span>
<span class="c1">#</span>
<span class="c1">#                       The password encryption key and encrypted password files must contain the same match value.</span>
<span class="c1">#                       The match values are compared to ensure that the two specified files are related to each other,</span>
<span class="c1">#                       serving as a &quot;sanity check&quot; to help avoid configuration errors.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                       This program uses a timestamp as a shared match value, but a timestamp is not required.</span>
<span class="c1">#                       Any shared string can serve as a match value. The timestamp is not related in any way to</span>
<span class="c1">#                       the encryption of the password, and the timestamp cannot be used to decrypt the password.</span>
<span class="c1">#</span>
<span class="c1">#                 key=HexDigits</span>
<span class="c1">#</span>
<span class="c1">#                       This value is the password encryption key, encoded as hex digits.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                 mac=MACAlgorithmName</span>
<span class="c1">#</span>
<span class="c1">#                       Specifies the message authentication code (MAC) algorithm HmacSHA1 or HmacSHA256.</span>
<span class="c1">#                       Stored Password Protection performs Encrypt-then-MAC for protection from a padding oracle attack.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                 mackey=HexDigits</span>
<span class="c1">#</span>
<span class="c1">#                       This value is the MAC key, encoded as hex digits.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#               Encrypted Password File Format</span>
<span class="c1">#               ------------------------------</span>
<span class="c1">#</span>
<span class="c1">#               The encrypted password file is a text file in Java Properties file format, using the ISO 8859-1 character encoding.</span>
<span class="c1">#</span>
<span class="c1">#               The file must contain the following string properties:</span>
<span class="c1">#</span>
<span class="c1">#                 version=1</span>
<span class="c1">#</span>
<span class="c1">#                       The version number must be 1.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                 match=MatchValue</span>
<span class="c1">#</span>
<span class="c1">#                       The password encryption key and encrypted password files must contain the same match value.</span>
<span class="c1">#                       The match values are compared to ensure that the two specified files are related to each other,</span>
<span class="c1">#                       serving as a &quot;sanity check&quot; to help avoid configuration errors.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                       This program uses a timestamp as a shared match value, but a timestamp is not required.</span>
<span class="c1">#                       Any shared string can serve as a match value. The timestamp is not related in any way to</span>
<span class="c1">#                       the encryption of the password, and the timestamp cannot be used to decrypt the password.</span>
<span class="c1">#</span>
<span class="c1">#                 password=HexDigits</span>
<span class="c1">#</span>
<span class="c1">#                       This value is the encrypted password, encoded as hex digits.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#                 params=HexDigits</span>
<span class="c1">#</span>
<span class="c1">#                       This value contains the cipher algorithm parameters, if any, encoded as hex digits.</span>
<span class="c1">#                       Some ciphers need algorithm parameters that cannot be derived from the key, such as an initialization vector.</span>
<span class="c1">#                       This property is optional, depending on whether the cipher algorithm has associated parameters.</span>
<span class="c1">#</span>
<span class="c1">#                       While this value is technically optional, an initialization vector is required by all three</span>
<span class="c1">#                       block cipher modes CBC, CFB, and OFB that are supported by the Teradata SQL Driver for Python.</span>
<span class="c1">#                       ECB (Electronic Codebook) does not require params, but ECB is not supported by the Teradata SQL Driver for Python.</span>
<span class="c1">#</span>
<span class="c1">#                 hash=HexDigits</span>
<span class="c1">#</span>
<span class="c1">#                       This value is the expected message authentication code (MAC), encoded as hex digits.</span>
<span class="c1">#                       After encryption, the expected MAC is calculated using the ciphertext, transformation name, and algorithm parameters if any.</span>
<span class="c1">#                       Before decryption, the Teradata SQL Driver for Python calculates the MAC using the ciphertext, transformation name,</span>
<span class="c1">#                       and algorithm parameters, if any, and verifies that the calculated MAC matches the expected MAC.</span>
<span class="c1">#                       If the calculated MAC differs from the expected MAC, then either or both of the files may have been tampered with.</span>
<span class="c1">#                       This property is required.</span>
<span class="c1">#</span>
<span class="c1">#               Transformation, Key Size, and MAC</span>
<span class="c1">#               ---------------------------------</span>
<span class="c1">#</span>
<span class="c1">#               A transformation is a string that describes the set of operations to be performed on the given input, to produce transformed output.</span>
<span class="c1">#               A transformation specifies the name of a cryptographic algorithm such as DES or AES, followed by a feedback mode and padding scheme.</span>
<span class="c1">#</span>
<span class="c1">#               The Teradata SQL Driver for Python supports the following transformations and key sizes.</span>
<span class="c1">#</span>
<span class="c1">#                  DES/CBC/NoPadding          64</span>
<span class="c1">#                  DES/CBC/PKCS5Padding       64</span>
<span class="c1">#                  DES/CFB/NoPadding          64</span>
<span class="c1">#                  DES/CFB/PKCS5Padding       64</span>
<span class="c1">#                  DES/OFB/NoPadding          64</span>
<span class="c1">#                  DES/OFB/PKCS5Padding       64</span>
<span class="c1">#                  DESede/CBC/NoPadding       192</span>
<span class="c1">#                  DESede/CBC/PKCS5Padding    192</span>
<span class="c1">#                  DESede/CFB/NoPadding       192</span>
<span class="c1">#                  DESede/CFB/PKCS5Padding    192</span>
<span class="c1">#                  DESede/OFB/NoPadding       192</span>
<span class="c1">#                  DESede/OFB/PKCS5Padding    192</span>
<span class="c1">#                  AES/CBC/NoPadding          128</span>
<span class="c1">#                  AES/CBC/NoPadding          192</span>
<span class="c1">#                  AES/CBC/NoPadding          256</span>
<span class="c1">#                  AES/CBC/PKCS5Padding       128</span>
<span class="c1">#                  AES/CBC/PKCS5Padding       192</span>
<span class="c1">#                  AES/CBC/PKCS5Padding       256</span>
<span class="c1">#                  AES/CFB/NoPadding          128</span>
<span class="c1">#                  AES/CFB/NoPadding          192</span>
<span class="c1">#                  AES/CFB/NoPadding          256</span>
<span class="c1">#                  AES/CFB/PKCS5Padding       128</span>
<span class="c1">#                  AES/CFB/PKCS5Padding       192</span>
<span class="c1">#                  AES/CFB/PKCS5Padding       256</span>
<span class="c1">#                  AES/OFB/NoPadding          128</span>
<span class="c1">#                  AES/OFB/NoPadding          192</span>
<span class="c1">#                  AES/OFB/NoPadding          256</span>
<span class="c1">#                  AES/OFB/PKCS5Padding       128</span>
<span class="c1">#                  AES/OFB/PKCS5Padding       192</span>
<span class="c1">#                  AES/OFB/PKCS5Padding       256</span>
<span class="c1">#</span>
<span class="c1">#               Stored Password Protection uses a symmetric encryption algorithm such as DES or AES, in which the same secret key is used for</span>
<span class="c1">#               encryption and decryption of the password. Stored Password Protection does not use an asymmetric encryption algorithm such as RSA,</span>
<span class="c1">#               with separate public and private keys.</span>
<span class="c1">#</span>
<span class="c1">#               CBC (Cipher Block Chaining) is a block cipher encryption mode. With CBC, each ciphertext block is dependent on all plaintext blocks</span>
<span class="c1">#               processed up to that point. CBC is suitable for encrypting data whose total byte count exceeds the algorithm&#39;s block size, and is</span>
<span class="c1">#               therefore suitable for use with Stored Password Protection.</span>
<span class="c1">#</span>
<span class="c1">#               Stored Password Protection hides the password length in the encrypted password file by extending the length of the UTF8-encoded</span>
<span class="c1">#               password with trailing null bytes. The length is extended to the next 512-byte boundary.</span>
<span class="c1">#</span>
<span class="c1">#               A block cipher with no padding, such as AES/CBC/NoPadding, may only be used to encrypt data whose byte count after extension is</span>
<span class="c1">#               a multiple of the algorithm&#39;s block size. The 512-byte boundary is compatible with many block ciphers. AES, for example, has a</span>
<span class="c1">#               block size of 128 bits (16 bytes), and is therefore compatible with the 512-byte boundary.</span>
<span class="c1">#</span>
<span class="c1">#               A block cipher with padding, such as AES/CBC/PKCS5Padding, can be used to encrypt data of any length. However, CBC with padding</span>
<span class="c1">#               is vulnerable to a &quot;padding oracle attack&quot;, so Stored Password Protection performs Encrypt-then-MAC for protection from a padding</span>
<span class="c1">#               oracle attack. MAC algorithms HmacSHA1 and HmacSHA256 are supported.</span>
<span class="c1">#</span>
<span class="c1">#               The Teradata SQL Driver for Python does not support block ciphers used as byte-oriented ciphers via modes such as CFB8 or OFB8.</span>
<span class="c1">#</span>
<span class="c1">#               The strength of the encryption depends on your choice of cipher algorithm and key size.</span>
<span class="c1">#</span>
<span class="c1">#               AES uses a 128-bit (16 byte), 192-bit (24 byte), or 256-bit (32 byte) key.</span>
<span class="c1">#               DESede uses a 192-bit (24 byte) key. The The Teradata SQL Driver for Python does not support a 128-bit (16 byte) key for DESede.</span>
<span class="c1">#               DES uses a 64-bit (8 byte) key.</span>
<span class="c1">#</span>
<span class="c1">#               Sharing Files with the Teradata JDBC Driver</span>
<span class="c1">#               -------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#               The Teradata SQL Driver for Python and the Teradata JDBC Driver can share the files containing the password encryption key and</span>
<span class="c1">#               encrypted password, if you use a transformation, key size, and MAC algorithm that is supported by both drivers.</span>
<span class="c1">#</span>
<span class="c1">#               Recommended choices for compatibility are AES/CBC/NoPadding and HmacSHA256.</span>
<span class="c1">#               Use a 256-bit key if your Java environment has the Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files</span>
<span class="c1">#               from Oracle.</span>
<span class="c1">#               Use a 128-bit key if your Java environment does not have the Unlimited Strength Jurisdiction Policy Files.</span>
<span class="c1">#               Use HmacSHA1 for compatibility with JDK 1.4.2.</span>
<span class="c1">#</span>
<span class="c1">#               File Locations</span>
<span class="c1">#               --------------</span>
<span class="c1">#</span>
<span class="c1">#               For the &quot;ENCRYPTED_PASSWORD(&quot; syntax of the Teradata SQL Driver for Python, each filename must be preceded by the file: prefix.</span>
<span class="c1">#               The PasswordEncryptionKeyFileName must be separated from the EncryptedPasswordFileName by a single comma.</span>
<span class="c1">#               The files can be located in the current directory, specified with a relative path, or specified with an absolute path.</span>
<span class="c1">#</span>
<span class="c1">#               Example for files in the current directory:</span>
<span class="c1">#</span>
<span class="c1">#                   ENCRYPTED_PASSWORD(file:JohnDoeKey.properties,file:JohnDoePass.properties)</span>
<span class="c1">#</span>
<span class="c1">#               Example with relative paths:</span>
<span class="c1">#</span>
<span class="c1">#                   ENCRYPTED_PASSWORD(file:../dir1/JohnDoeKey.properties,file:../dir2/JohnDoePass.properties)</span>
<span class="c1">#</span>
<span class="c1">#               Example with absolute paths on Windows:</span>
<span class="c1">#</span>
<span class="c1">#                   ENCRYPTED_PASSWORD(file:c:/dir1/JohnDoeKey.properties,file:c:/dir2/JohnDoePass.properties)</span>
<span class="c1">#</span>
<span class="c1">#               Example with absolute paths on Linux:</span>
<span class="c1">#</span>
<span class="c1">#                   ENCRYPTED_PASSWORD(file:/dir1/JohnDoeKey.properties,file:/dir2/JohnDoePass.properties)</span>

<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">Crypto.Cipher</span>
<span class="kn">import</span> <span class="nn">Crypto.Cipher.AES</span>
<span class="kn">import</span> <span class="nn">Crypto.Cipher.DES</span>
<span class="kn">import</span> <span class="nn">Crypto.Cipher.DES3</span>
<span class="kn">import</span> <span class="nn">Crypto.Hash</span>
<span class="kn">import</span> <span class="nn">Crypto.Hash.SHA1</span>
<span class="kn">import</span> <span class="nn">Crypto.Hash.SHA256</span>
<span class="kn">import</span> <span class="nn">Crypto.Random</span>
<span class="kn">import</span> <span class="nn">Crypto.Util.asn1</span>
<span class="kn">import</span> <span class="nn">Crypto.Util.Padding</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>

<div class="viewcode-block" id="j2p"><a class="viewcode-back" href="../../database_connections.html#database_connections.TJEncryptPassword.j2p">[docs]</a><span class="k">def</span> <span class="nf">j2p</span> <span class="p">(</span><span class="n">sName</span><span class="p">):</span> <span class="c1"># convert Java names to Python names</span>

    <span class="k">if</span> <span class="n">sName</span> <span class="o">==</span> <span class="s2">&quot;DESede&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;DES3&quot;</span>

    <span class="k">if</span> <span class="n">sName</span><span class="o">.</span><span class="n">startswith</span> <span class="p">(</span><span class="s2">&quot;Hmac&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sName</span> <span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="p">]</span> <span class="c1"># trim Hmac prefix</span>

    <span class="k">if</span> <span class="n">sName</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CBC&quot;</span><span class="p">,</span> <span class="s2">&quot;CFB&quot;</span><span class="p">,</span> <span class="s2">&quot;OFB&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">&quot;MODE_&quot;</span> <span class="o">+</span> <span class="n">sName</span>

    <span class="k">return</span> <span class="n">sName</span></div>

    <span class="c1"># end j2p</span>

<div class="viewcode-block" id="createPasswordEncryptionKeyFile"><a class="viewcode-back" href="../../database_connections.html#database_connections.TJEncryptPassword.createPasswordEncryptionKeyFile">[docs]</a><span class="k">def</span> <span class="nf">createPasswordEncryptionKeyFile</span> <span class="p">(</span><span class="n">sTransformation</span><span class="p">,</span> <span class="n">sAlgorithm</span><span class="p">,</span> <span class="n">sMode</span><span class="p">,</span> <span class="n">sPadding</span><span class="p">,</span> <span class="n">nKeySizeInBits</span><span class="p">,</span> <span class="n">sMatch</span><span class="p">,</span> <span class="n">sMac</span><span class="p">,</span> <span class="n">sPassKeyFileName</span><span class="p">):</span>

    <span class="n">nKeySizeInBytes</span> <span class="o">=</span> <span class="n">nKeySizeInBits</span> <span class="o">//</span> <span class="mi">8</span>

    <span class="n">moduleCipher</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sAlgorithm</span><span class="p">))</span>
    <span class="n">nMode</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">moduleCipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMode</span><span class="p">))</span>

    <span class="n">abyKey</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span> <span class="p">(</span><span class="n">nKeySizeInBytes</span><span class="p">)</span>
    <span class="n">sKeyHexDigits</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span> <span class="p">(</span><span class="n">abyKey</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span> <span class="p">()</span>

    <span class="n">moduleHash</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMac</span><span class="p">))</span>
    <span class="n">nMacBlockSizeInBytes</span> <span class="o">=</span> <span class="n">moduleHash</span><span class="o">.</span><span class="n">block_size</span>

    <span class="n">abyMacKey</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span> <span class="p">(</span><span class="n">nMacBlockSizeInBytes</span><span class="p">)</span>
    <span class="n">sMacKeyHexDigits</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span> <span class="p">(</span><span class="n">abyMacKey</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span> <span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s2">&quot;# Teradata SQL Driver password encryption key file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;version=1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;transformation=&quot;</span> <span class="o">+</span> <span class="n">sTransformation</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;algorithm=&quot;</span> <span class="o">+</span> <span class="n">sAlgorithm</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;match=&quot;</span> <span class="o">+</span> <span class="n">sMatch</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;key=&quot;</span> <span class="o">+</span> <span class="n">sKeyHexDigits</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;mac=&quot;</span> <span class="o">+</span> <span class="n">sMac</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;mackey=&quot;</span> <span class="o">+</span> <span class="n">sMacKeyHexDigits</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">abyKey</span><span class="p">,</span> <span class="n">abyMacKey</span></div>

    <span class="c1"># end createPasswordEncryptionKeyFile</span>

<div class="viewcode-block" id="createEncryptedPasswordFile"><a class="viewcode-back" href="../../database_connections.html#database_connections.TJEncryptPassword.createEncryptedPasswordFile">[docs]</a><span class="k">def</span> <span class="nf">createEncryptedPasswordFile</span> <span class="p">(</span><span class="n">sTransformation</span><span class="p">,</span> <span class="n">sAlgorithm</span><span class="p">,</span> <span class="n">sMode</span><span class="p">,</span> <span class="n">sPadding</span><span class="p">,</span> <span class="n">sMatch</span><span class="p">,</span> <span class="n">abyKey</span><span class="p">,</span> <span class="n">sMac</span><span class="p">,</span> <span class="n">abyMacKey</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">,</span> <span class="n">sPassword</span><span class="p">):</span>

    <span class="n">moduleCipher</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sAlgorithm</span><span class="p">))</span>
    <span class="n">nMode</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">moduleCipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMode</span><span class="p">))</span>

    <span class="n">bPadding</span> <span class="o">=</span> <span class="n">sPadding</span> <span class="o">==</span> <span class="s2">&quot;PKCS5Padding&quot;</span>

    <span class="n">nBlockSizeInBytes</span> <span class="o">=</span> <span class="n">moduleCipher</span><span class="o">.</span><span class="n">block_size</span>
    <span class="n">abyIV</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span> <span class="p">(</span><span class="n">nBlockSizeInBytes</span><span class="p">)</span>

    <span class="n">abyASN1EncodedIV</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">asn1</span><span class="o">.</span><span class="n">DerOctetString</span> <span class="p">(</span><span class="n">abyIV</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span> <span class="p">()</span>
    <span class="n">sASN1EncodedIVHexDigits</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span> <span class="p">(</span><span class="n">abyASN1EncodedIV</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span> <span class="p">()</span>

    <span class="n">mapOptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mapOptions</span> <span class="p">[</span><span class="s1">&#39;iv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abyIV</span>

    <span class="k">if</span> <span class="n">sMode</span> <span class="o">==</span> <span class="s2">&quot;CFB&quot;</span><span class="p">:</span>
        <span class="n">nBlockSizeInBits</span> <span class="o">=</span> <span class="n">nBlockSizeInBytes</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">mapOptions</span> <span class="p">[</span><span class="s1">&#39;segment_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nBlockSizeInBits</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">moduleCipher</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">nMode</span><span class="p">,</span> <span class="o">**</span><span class="n">mapOptions</span><span class="p">)</span>

    <span class="n">abyPassword</span> <span class="o">=</span> <span class="n">sPassword</span><span class="o">.</span><span class="n">encode</span> <span class="p">()</span>

    <span class="n">nPlaintextByteCount</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">abyPassword</span><span class="p">)</span> <span class="o">//</span> <span class="mi">512</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span> <span class="c1"># zero-pad the password to the next 512-byte boundary</span>

    <span class="n">nTrailerByteCount</span> <span class="o">=</span> <span class="n">nPlaintextByteCount</span> <span class="o">-</span> <span class="nb">len</span> <span class="p">(</span><span class="n">abyPassword</span><span class="p">)</span>
    <span class="n">abyPassword</span> <span class="o">+=</span> <span class="nb">bytearray</span> <span class="p">(</span><span class="n">nTrailerByteCount</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bPadding</span><span class="p">:</span>
        <span class="n">abyPassword</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">Padding</span><span class="o">.</span><span class="n">pad</span> <span class="p">(</span><span class="n">abyPassword</span><span class="p">,</span> <span class="n">nBlockSizeInBytes</span><span class="p">)</span>

    <span class="n">abyEncryptedPassword</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span> <span class="p">(</span><span class="n">abyPassword</span><span class="p">)</span>
    <span class="n">sEncryptedPasswordHexDigits</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span> <span class="p">(</span><span class="n">abyEncryptedPassword</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span> <span class="p">()</span>

    <span class="n">abyContent</span> <span class="o">=</span> <span class="n">abyEncryptedPassword</span> <span class="o">+</span> <span class="n">sTransformation</span><span class="o">.</span><span class="n">encode</span> <span class="p">()</span> <span class="o">+</span> <span class="n">abyASN1EncodedIV</span>

    <span class="n">moduleHash</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMac</span><span class="p">))</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="o">.</span><span class="n">HMAC</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">abyMacKey</span><span class="p">,</span> <span class="n">abyContent</span><span class="p">,</span> <span class="n">moduleHash</span><span class="p">)</span>
    <span class="n">sHashHexDigits</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span> <span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">sEncPassFileName</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s2">&quot;# Teradata SQL Driver encrypted password file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;version=1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;match=&quot;</span> <span class="o">+</span> <span class="n">sMatch</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;password=&quot;</span> <span class="o">+</span> <span class="n">sEncryptedPasswordHexDigits</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;params=&quot;</span> <span class="o">+</span> <span class="n">sASN1EncodedIVHexDigits</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;hash=&quot;</span> <span class="o">+</span> <span class="n">sHashHexDigits</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="c1"># end createEncryptedPasswordFile</span>

<div class="viewcode-block" id="loadPropertiesFile"><a class="viewcode-back" href="../../database_connections.html#database_connections.TJEncryptPassword.loadPropertiesFile">[docs]</a><span class="k">def</span> <span class="nf">loadPropertiesFile</span> <span class="p">(</span><span class="n">sFileName</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">sFileName</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sFileContents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span> <span class="p">()</span>

    <span class="n">mapOutput</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">sLine</span> <span class="ow">in</span> <span class="n">sFileContents</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">sLine</span> <span class="o">=</span> <span class="n">sLine</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
        <span class="k">if</span> <span class="n">sLine</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sLine</span><span class="o">.</span><span class="n">startswith</span> <span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="n">asTokens</span> <span class="o">=</span> <span class="n">sLine</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">sKey</span> <span class="o">=</span> <span class="n">asTokens</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
            <span class="n">sValue</span> <span class="o">=</span> <span class="n">asTokens</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span> <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">asTokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">mapOutput</span> <span class="p">[</span><span class="n">sKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">sValue</span>

    <span class="k">return</span> <span class="n">mapOutput</span></div>

    <span class="c1"># end loadPropertiesFile</span>

<div class="viewcode-block" id="decryptPassword"><a class="viewcode-back" href="../../database_connections.html#database_connections.TJEncryptPassword.decryptPassword">[docs]</a><span class="k">def</span> <span class="nf">decryptPassword</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">):</span>

    <span class="n">mapPassKey</span> <span class="o">=</span> <span class="n">loadPropertiesFile</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">)</span>
    <span class="n">mapEncPass</span> <span class="o">=</span> <span class="n">loadPropertiesFile</span> <span class="p">(</span><span class="n">sEncPassFileName</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unrecognized version </span><span class="si">{}</span><span class="s2"> in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">sPassKeyFileName</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unrecognized version </span><span class="si">{}</span><span class="s2"> in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">sEncPassFileName</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Match value differs between files </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">))</span>

    <span class="n">sTransformation</span>  <span class="o">=</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;transformation&quot;</span><span class="p">]</span>
    <span class="n">sAlgorithm</span>       <span class="o">=</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;algorithm&quot;</span><span class="p">]</span>
    <span class="n">sKeyHexDigits</span>    <span class="o">=</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
    <span class="n">sMACAlgorithm</span>    <span class="o">=</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;mac&quot;</span><span class="p">]</span>
    <span class="n">sMacKeyHexDigits</span> <span class="o">=</span> <span class="n">mapPassKey</span> <span class="p">[</span><span class="s2">&quot;mackey&quot;</span><span class="p">]</span>

    <span class="n">asTransformationParts</span> <span class="o">=</span> <span class="n">sTransformation</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

    <span class="n">sMode</span>    <span class="o">=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sPadding</span> <span class="o">=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sAlgorithm</span> <span class="o">!=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Algorithm differs from transformation in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">))</span>

    <span class="c1"># While params is technically optional, an initialization vector is required by all three block</span>
    <span class="c1"># cipher modes CBC, CFB, and OFB that are supported by the Teradata SQL Driver for Python.</span>
    <span class="c1"># ECB does not require params, but ECB is not supported by the Teradata SQL Driver for Python.</span>

    <span class="n">sEncryptedPasswordHexDigits</span> <span class="o">=</span> <span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
    <span class="n">sASN1EncodedIVHexDigits</span>     <span class="o">=</span> <span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="c1"># required for CBC, CFB, and OFB</span>
    <span class="n">sHashHexDigits</span>              <span class="o">=</span> <span class="n">mapEncPass</span> <span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span>

    <span class="n">abyKey</span>               <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span> <span class="p">(</span><span class="n">sKeyHexDigits</span><span class="p">)</span>
    <span class="n">abyMacKey</span>            <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span> <span class="p">(</span><span class="n">sMacKeyHexDigits</span><span class="p">)</span>
    <span class="n">abyEncryptedPassword</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span> <span class="p">(</span><span class="n">sEncryptedPasswordHexDigits</span><span class="p">)</span>
    <span class="n">abyASN1EncodedIV</span>     <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span> <span class="p">(</span><span class="n">sASN1EncodedIVHexDigits</span><span class="p">)</span>

    <span class="n">abyContent</span> <span class="o">=</span> <span class="n">abyEncryptedPassword</span> <span class="o">+</span> <span class="n">sTransformation</span><span class="o">.</span><span class="n">encode</span> <span class="p">()</span> <span class="o">+</span> <span class="n">abyASN1EncodedIV</span>

    <span class="n">moduleHash</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMACAlgorithm</span><span class="p">))</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Hash</span><span class="o">.</span><span class="n">HMAC</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">abyMacKey</span><span class="p">,</span> <span class="n">abyContent</span><span class="p">,</span> <span class="n">moduleHash</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sHashHexDigits</span> <span class="o">!=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span> <span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Hash mismatch indicates possible tampering with file </span><span class="si">{}</span><span class="s2"> or </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">))</span>

    <span class="n">nKeySizeInBytes</span> <span class="o">=</span> <span class="nb">len</span> <span class="p">(</span><span class="n">abyKey</span><span class="p">)</span>
    <span class="n">nKeySizeInBits</span> <span class="o">=</span> <span class="n">nKeySizeInBytes</span> <span class="o">*</span> <span class="mi">8</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> specifies </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">-bit key and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sTransformation</span><span class="p">,</span> <span class="n">nKeySizeInBits</span><span class="p">,</span> <span class="n">sMACAlgorithm</span><span class="p">))</span>

    <span class="n">moduleCipher</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sAlgorithm</span><span class="p">))</span>
    <span class="n">nMode</span> <span class="o">=</span> <span class="nb">getattr</span> <span class="p">(</span><span class="n">moduleCipher</span><span class="p">,</span> <span class="n">j2p</span> <span class="p">(</span><span class="n">sMode</span><span class="p">))</span>

    <span class="n">dos</span> <span class="o">=</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Util</span><span class="o">.</span><span class="n">asn1</span><span class="o">.</span><span class="n">DerOctetString</span> <span class="p">()</span>
    <span class="n">dos</span><span class="o">.</span><span class="n">decode</span> <span class="p">(</span><span class="n">abyASN1EncodedIV</span><span class="p">)</span>
    <span class="n">abyIV</span> <span class="o">=</span> <span class="n">dos</span><span class="o">.</span><span class="n">payload</span>

    <span class="n">mapOptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mapOptions</span> <span class="p">[</span><span class="s1">&#39;iv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abyIV</span>

    <span class="n">nBlockSizeInBytes</span> <span class="o">=</span> <span class="n">moduleCipher</span><span class="o">.</span><span class="n">block_size</span>
    <span class="n">nBlockSizeInBits</span> <span class="o">=</span> <span class="n">nBlockSizeInBytes</span> <span class="o">*</span> <span class="mi">8</span>

    <span class="k">if</span> <span class="n">sMode</span> <span class="o">==</span> <span class="s2">&quot;CFB&quot;</span><span class="p">:</span>
        <span class="n">mapOptions</span> <span class="p">[</span><span class="s1">&#39;segment_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nBlockSizeInBits</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">moduleCipher</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">abyKey</span><span class="p">,</span> <span class="n">nMode</span><span class="p">,</span> <span class="o">**</span><span class="n">mapOptions</span><span class="p">)</span>

    <span class="n">abyPassword</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span> <span class="p">(</span><span class="n">abyEncryptedPassword</span><span class="p">)</span>

    <span class="n">iZeroByte</span> <span class="o">=</span> <span class="n">abyPassword</span><span class="o">.</span><span class="n">index</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sPassword</span> <span class="o">=</span> <span class="n">abyPassword</span> <span class="p">[</span> <span class="p">:</span> <span class="n">iZeroByte</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span> <span class="p">()</span>

    <span class="c1">#print (&quot;Decrypted password:&quot;, sPassword)</span>

    <span class="k">return</span> <span class="n">sPassword</span></div>


<span class="c1"># begin main program</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Parameters: Transformation KeySizeInBits MAC PasswordEncryptionKeyFileName EncryptedPasswordFileName Hostname Username Password&quot;</span><span class="p">)</span>
        <span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sTransformation</span>  <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sKeySizeInBits</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">sMac</span>             <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sPassKeyFileName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">sEncPassFileName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">sHostname</span>        <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">sUsername</span>        <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">sPassword</span>        <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span>

    <span class="n">asTransformationParts</span> <span class="o">=</span> <span class="n">sTransformation</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">asTransformationParts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Invalid transformation &quot;</span> <span class="o">+</span> <span class="n">sTransformation</span><span class="p">)</span>

    <span class="n">sAlgorithm</span> <span class="o">=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sMode</span>      <span class="o">=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sPadding</span>   <span class="o">=</span> <span class="n">asTransformationParts</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sAlgorithm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DES&quot;</span><span class="p">,</span> <span class="s2">&quot;DESede&quot;</span><span class="p">,</span> <span class="s2">&quot;AES&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unknown algorithm &quot;</span> <span class="o">+</span> <span class="n">sAlgorithm</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sMode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CBC&quot;</span><span class="p">,</span> <span class="s2">&quot;CFB&quot;</span><span class="p">,</span> <span class="s2">&quot;OFB&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unknown mode &quot;</span> <span class="o">+</span> <span class="n">sMode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sPadding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PKCS5Padding&quot;</span><span class="p">,</span> <span class="s2">&quot;NoPadding&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unknown padding &quot;</span> <span class="o">+</span> <span class="n">sPadding</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sMac</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HmacSHA1&quot;</span><span class="p">,</span> <span class="s2">&quot;HmacSHA256&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Unknown MAC algorithm &quot;</span> <span class="o">+</span> <span class="n">sMac</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sPassword</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Password cannot be zero length&quot;</span><span class="p">)</span>

    <span class="n">sPassword</span> <span class="o">=</span> <span class="n">sPassword</span><span class="o">.</span><span class="n">encode</span> <span class="p">()</span><span class="o">.</span><span class="n">decode</span> <span class="p">(</span><span class="s1">&#39;unicode_escape&#39;</span><span class="p">)</span> <span class="c1"># for backslash uXXXX escape sequences</span>

    <span class="n">nKeySizeInBits</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="n">sKeySizeInBits</span><span class="p">)</span>
    <span class="n">sMatch</span> <span class="o">=</span> <span class="nb">str</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span> <span class="p">())</span>

    <span class="n">abyKey</span><span class="p">,</span> <span class="n">abyMacKey</span> <span class="o">=</span> <span class="n">createPasswordEncryptionKeyFile</span> <span class="p">(</span><span class="n">sTransformation</span><span class="p">,</span> <span class="n">sAlgorithm</span><span class="p">,</span> <span class="n">sMode</span><span class="p">,</span> <span class="n">sPadding</span><span class="p">,</span> <span class="n">nKeySizeInBits</span><span class="p">,</span> <span class="n">sMatch</span><span class="p">,</span> <span class="n">sMac</span><span class="p">,</span> <span class="n">sPassKeyFileName</span><span class="p">)</span>

    <span class="n">createEncryptedPasswordFile</span> <span class="p">(</span><span class="n">sTransformation</span><span class="p">,</span> <span class="n">sAlgorithm</span><span class="p">,</span> <span class="n">sMode</span><span class="p">,</span> <span class="n">sPadding</span><span class="p">,</span> <span class="n">sMatch</span><span class="p">,</span> <span class="n">abyKey</span><span class="p">,</span> <span class="n">sMac</span><span class="p">,</span> <span class="n">abyMacKey</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">,</span> <span class="n">sPassword</span><span class="p">)</span>

    <span class="n">decryptPassword</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">)</span>

    <span class="n">sPassword</span> <span class="o">=</span> <span class="s2">&quot;ENCRYPTED_PASSWORD(file:</span><span class="si">{}</span><span class="s2">,file:</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span> <span class="p">(</span><span class="n">sPassKeyFileName</span><span class="p">,</span> <span class="n">sEncPassFileName</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, James Kabbes.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>